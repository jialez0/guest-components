name: Generate per-RPM SLSA provenance (per-file)

on:
  workflow_call:
    inputs:
      rpm-root:
        description: "Root directory to search for RPM packages (default: workspace root)"
        required: false
        type: string
        default: "."
      private-repository:
        description: "If true, allow posting provenance for private repositories to the public transparency log"
        required: false
        type: boolean
        default: false
      rekor-intoto-upload:
        description: "If true, additionally upload provenance to Rekor using the intoto entry type so that payload bytes can be stored via attestation storage"
        required: false
        type: boolean
        default: false
      rekor-url:
        description: "Rekor base URL to use for intoto uploads"
        required: false
        type: string
        default: "https://rekor.sigstore.dev"

jobs:
  per-rpm-provenance:
    runs-on: ubuntu-latest
    permissions:
      id-token: write     # For keyless signing via OIDC
      contents: write      # For reading repo metadata
      actions: read       # For reading workflow path
    env:
      BUILDER_BINARY: slsa-generator-generic-linux-amd64
      BUILDER_DIR: internal/builders/generic

    steps:
      - name: Checkout repository (scripts only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./
          merge-multiple: false

      - name: Install rpm tooling
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y rpm2cpio cpio

      - name: Generate generic SLSA generator binary
        uses: slsa-framework/slsa-github-generator/.github/actions/generate-builder@v2.1.0
        with:
          repository: "slsa-framework/slsa-github-generator"
          ref: "refs/tags/v2.1.0"
          go-version: "1.23.1"
          binary: "${{ env.BUILDER_BINARY }}"
          compile-builder: false
          directory: "${{ env.BUILDER_DIR }}"
          allow-private-repository: ${{ inputs.private-repository }}

      - name: Generate per-RPM per-file provenance
        env:
          RPM_ROOT: ${{ inputs.rpm-root }}
          # These are required by the generic SLSA builder binary.
          GITHUB_CONTEXT: ${{ toJSON(github) }}
          VARS_CONTEXT: ${{ toJSON(vars) }}
        run: bash .github/scripts/generate_rpm_per_file_provenance.sh

      - name: Upload per-RPM provenance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-provenance
          path: rpm-provenance/*.intoto.jsonl
          if-no-files-found: error

      - name: Install rekor-cli for intoto uploads
        if: inputs.rekor-intoto-upload
        run: |
          set -euo pipefail
          REKOR_VERSION="v1.3.6"
          curl -L "https://github.com/sigstore/rekor/releases/download/${REKOR_VERSION}/rekor-cli-linux-amd64" -o rekor-cli
          chmod +x rekor-cli
          sudo mv rekor-cli /usr/local/bin/rekor-cli

      - name: Upload provenance to Rekor using intoto entries
        if: inputs.rekor-intoto-upload
        env:
          REKOR_URL: ${{ inputs.rekor-url }}
        run: bash .github/scripts/upload_provenance_to_rekor.sh



